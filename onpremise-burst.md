# クラウド計算環境からオンプレミス計算機へのジョブ投入

クラウド計算環境からオンプレミス計算機上のジョブスケジューラにジョブを投入する。
ここで紹介する方法は、クラウド環境上に用意したジョブ投入用S3バケットとオンプレミス計算機のストレージを定期的に同期し、
これにより、S3バケットを介した自動ジョブ投入を実現する。
定期的な同期にはオンプレミス計算機上のcron機能を利用する。
この方法は、クラウド計算環境からオンプレミス計算機に対する直接操作が不要であるため、
オンプレミス計算機とクラウド計算環境の認証連携機能は用いない。
また、オンプレミス計算機の認証情報をクラウド計算環境にコピーする必要も無い。

## ジョブ投入用S3バケット作成

オンプレミス計算機にジョブを投入する際、必要なファイルを送信したり、
ジョブの結果を格納するために利用するS3バケットを作成する。
```bash
$ aws s3 mb s3://{ジョブ投入用バケット名}
```

## ジョブ管理スクリプトの作成

オンプレミス計算機のテキストエディタでホームディレクトリ上の aws-jobmanager.sh という名前のテキストファイルを新規に開き、
以下の内容を記述する。
ここで、S3_PROFILEにはAWSプロファイルの名前を、S3_JOB_BUCKET_NAMEにはジョブ投入用S3バケットの名前を、
それぞれ記述する。

```
```

その後、以下のコマンドで実行権を与える。
```bash
$ chmod u+x aws-jobmanager.sh
```

## ジョブ管理スクリプトの自動実行設定

オンプレミス計算機のテキストエディタで cron.txtという名前のテキストファイルを新規に開き、
以下の内容を記述する。
なお、これは毎時00分にホームディレクトリの aws-jobmanager.sh を起動する、
というcrontabの設定である。
起動の頻度は、crontabの書式に従って調整することが出来る。

```
00 * * * * ${HOME}/aws-jobmanager.sh
```

その後、以下のコマンドを実行して内容をオンプレミス計算機のcronに登録する。
```bash
$ crontab cron.txt
```

これにより、この設定が適用され、ジョブ管理スクリプトが定期的に自動実行されるようになる。

## ジョブの投入

### プレフィクスを決める
S3バケットにファイルをコピーする際に使用するプレフィクスとして、ジョブ毎に異なる名前（例えば job0001 など）を決めておく。

### ジョブスクリプトの作成
オンプレミス計算機のジョブスケジューラ向けのジョブスクリプトを作成し、
クラウド計算環境で、s3://{ジョブ投入用バケット名}/{ジョブのプレフィクス}/aws-job-run.sh という名前のオブジェクトとして保存する。
この中で、プログラムのコンパイルや実行など、ジョブとして実行したいコマンドを記述する。

### ジョブに必要なファイルのコピー
ジョブに必要なファイルをジョブ投入用S3バケットにジョブのプレフィクスを付けてコピーする。

### ジョブの状態通知オブジェクトをジョブ投入用S3バケットにコピー
ジョブに必要なファイルのコピーが完了したら、以下の内容のテキストファイルを作成し、
s3://{ジョブ投入用バケット名}/{ジョブのプレフィクス}/aws-job-stat.txt という名前のオブジェクトとしてコピーする。
```
FILE_UPLOAD
```

これにより、必要なファイルが全てジョブ投入用S3バケットに保存されたことをオンプレミス計算機上のジョブ管理スクリプトが認識し、
ジョブを自動投入する。

## ジョブの結果取得
オンプレミス計算機上のジョブスクリプトと同じディレクトリに作成されたファイルやディレクトリは、
ジョブの実行完了後、ジョブ投入用S3バケットに、そのジョブのプレフィクスを付けたオブジェクトとして保存されるので、
適宜内容を確認する。

## ジョブ自動実行機能の停止
オンプレミス計算機でのジョブ自動実行機能を停止するには、オンプレミス計算機で以下を実行する。
```bash
$ crontab -r
```

自動実行機能を再開するには、前述の「ジョブ管理スクリプトの自動実行設定」を再度実行する。

## オブジェクトやファイル、ディレクトリの削除
今回紹介した方法では、ジョブ投入用S3バケット内のオブジェクトや、オンプレミス計算機上のファイル、ディレクトリは、自動的に削除されない。
そのため、不要になった場合は、利用者が適宜削除する。
削除する場合、ジョブ自動実行機能が誤動作しないように、
まずジョブ投入用S3バケット内のオブジェクトを削除してから、対応するオンプレミス計算機のファイルやディレクトリを削除する。
なお、オンプレミス計算機では、ホームディレクトリ上の aws-jobディレクトリの中に、
プレフィクスと同じ名前のディレクトリが作成され、その中に、そのジョブで使用したファイルやそのジョブが作成したファイルが保存される。
そのため、プレフィクス単位でディレクトリを削除することが出来る。



